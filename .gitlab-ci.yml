image: node:latest

variables:
  GIT_DEPTH: 0  # Fetch all history for proper access

stages:
  - build
  - test
  - release

build:
  stage: build
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/

test:
  stage: test
  script:
    - npm ci
    - npm run build
    # Create test policies
    - |
      mkdir -p test/policies
      cat > test/policies/valid.tf << 'EOL'
      resource "oci_identity_policy" "test_policy" {
        statements = [
          "Allow group Administrators to manage all-resources in tenancy",
          "Allow group Developers to use instances in compartment dev",
          "Define tenancy Acceptor as ocid1.tenancy.oc1..aaaaaa",
          "Endorse group NetworkAdmins to manage virtual-network-family in tenancy foo",
          "Admit group ServiceAdmins of tenancy accountFoo to manage instances in tenancy",
          "Allow group SecurityAdmins to manage all-resources in tenancy where request.user.groups contains 'SecurityAdmins'"
        ]
      }
      EOL

      cat > test/policies/invalid.tf << 'EOL'
      resource "oci_identity_policy" "invalid_policy" {
        statements = [
          "AllowBadSyntax manage",
          "Allow groupDevelopers to use instances in compartment dev",
          "Admitgroup ServiceAdmins of tenancy 123 to manage instances in tenancy"
        ]
      }
      EOL

      cat > test/policies/variables.tf << 'EOL'
      resource "oci_identity_policy" "test_policy_vars" {
        statements = [
          "Allow group ${var.admin_group} to manage all-resources in tenancy",
          "Define tenancy ${var.tenant_name} as ${var.tenant_ocid}",
          "Endorse group ${var.network_admins} to manage virtual-network-family in tenancy foo",
          "Admit group ${var.dev_group} of tenancy accountFoo to use instances in compartment ${var.env}",
          "Allow any-user to use instances in compartment ${var.public_compartment} where request.time BETWEEN ${var.start_time} AND ${var.end_time}"
        ]
      }
      EOL
    # Run validation
    - node lib/cli.js --path test/policies/valid.tf  # Fix entry point name
  artifacts:
    reports:
      junit: test-results.xml

release:
  stage: release
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - npm ci
    - npm run build
    # Package for GitLab registry
    - |
      echo "registry=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/npm/" >> .npmrc
      echo "//${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}" >> .npmrc
    - npm publish

validate_policies:
  image: node:latest
  script:
    - npm ci
    - npm run build
    # Create test files similar to GitHub Actions workflow
    - mkdir -p test/policies
    - |
      cat > test/policies/all_expressions.tf << 'EOL'
      resource "oci_identity_policy" "all_expressions" {
        statements = [
          "Define group Administrators as admins",
          "Endorse group Developers to use instances in tenancy",
          "Admit group ServiceAdmins of tenancy-abc to manage instances in compartment prod",
          "Allow group admins to manage all-resources in tenancy"
        ]
      }
      EOL
    - npx policy-validation-action --path test/policies
