name: Test Policy Validation Action
on: [push, pull_request]

jobs:
  test-action:
    runs-on: ubuntu-latest
    name: Test Policy Validation
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build action
        run: npm run build
        
      - name: Create test policies
        run: |
          mkdir -p test/policies
          # Valid policy file
          cat > test/policies/valid.tf << 'EOL'
          resource "oci_identity_policy" "valid_policy" {
            statements = [
              "Allow group Administrators to manage all-resources in tenancy",
              "Allow group Developers to use instances in compartment dev"
            ]
          }
          EOL
          
          # Invalid policy file
          cat > test/policies/invalid.tf << 'EOL'
          resource "oci_identity_policy" "invalid_policy" {
            statements = [
              "Invalid policy statement that should fail",
              "Allow BadSyntax manage"
            ]
          }
          EOL
          
          # Valid policy file with HCL variables
          cat > test/policies/valid_vars.tf << 'EOL'
          resource "oci_identity_policy" "valid_policy_vars" {
            statements = [
              "Allow group ${var.admin_group} to manage all-resources in tenancy",
              "Allow group Developers to use ${var.resource_type} in compartment ${var.dev_compartment}",
              "Allow any-user to use ${var.public_resource} in compartment ${var.public_compartment} where request.user.id = '${var.allowed_user}'"
            ]
          }
          EOL
          
          # Verify files were created
          ls -la test/policies/
          cat test/policies/valid.tf
          cat test/policies/invalid.tf
          
      - name: Test valid policy
        id: test-valid
        continue-on-error: true
        uses: ./
        with:
          path: './test/policies/valid.tf'
          
      - name: Test invalid policy
        id: test-invalid
        continue-on-error: true
        uses: ./
        with:
          path: './test/policies/invalid.tf'
          
      - name: Test policy with variables
        id: test-vars
        continue-on-error: true
        uses: ./
        with:
          path: './test/policies/valid_vars.tf'
          
      - name: Verify test results
        run: |
          # Valid policy should succeed
          if [ "${{ steps.test-valid.outcome }}" != "success" ]; then
            echo "Valid policy test failed unexpectedly"
            exit 1
          fi
          
          # Invalid policy should fail
          if [ "${{ steps.test-invalid.outcome }}" != "failure" ]; then
            echo "Invalid policy test succeeded unexpectedly"
            exit 1
          fi
          
          # Variable interpolation test should succeed
          if [ "${{ steps.test-vars.outcome }}" != "success" ]; then
            echo "Variable interpolation test failed unexpectedly"
            exit 1
          fi
          
          # Check output format
          if [ -z "${{ steps.test-valid.outputs.allow_segments }}" ]; then
            echo "No segments found in valid policy"
            exit 1
          fi
          
          # Check if variables were properly handled
          if [[ ! "${{ steps.test-vars.outputs.allow_segments }}" == *"${var.admin_group}"* ]]; then
            echo "Variable interpolation not properly preserved in output"
            exit 1
          fi
